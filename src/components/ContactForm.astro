---
import InputField from "./contact/InputField.astro";

interface Props {
    className?: string;
}

const { className = "" } = Astro.props;
import SubmitButton from "./contact/SubmitButton.astro";
import TextareaCounter from "./contact/TextareaCounter.tsx";
---

<form
    id="contact-form"
    class={`w-full mx-auto p-8 ${className}`}
    data-loading="false"
    novalidate
>
    <!-- Honeypot field (hidden) para detectar bots -->
    <!-- <input
        type="text"
        name="website"
        id="website"
        autocomplete="off"
        tabindex="-1"
        style="position: absolute; left: -9999px; opacity: 0;"
        aria-hidden="true"
    /> -->

    <div class="grid gap-6 grid-cols-1 sm:grid-cols-2">
        <InputField
            label="Nombre completo"
            name="name"
            id="name"
            type="text"
            placeholder="Tu nombre"
            required
            maxlength={50}
            className=""
        />

        <InputField
            label="Correo electrónico"
            name="email"
            id="email"
            type="email"
            placeholder="tu@email.com"
            required
            maxlength={100}
            className=""
        />

        <InputField
            label="Asunto"
            name="subject"
            id="subject"
            type="text"
            placeholder="¿En qué puedo ayudarte?"
            required
            maxlength={100}
            fullWidth
        />

        <TextareaCounter client:load />

        <SubmitButton label="Enviar mensaje" id="submit-btn" />
    </div>

    <!-- Mensaje de resultado -->
    <div class="form-result" id="form-result" style="display: none;">
        <div class="result-content">
            <span class="result-icon"></span>
            <span class="result-message"></span>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", async () => {
            // Importar esquema de validación
            const { contactSchema } = await import("../shared/contactSchema");

            const form = document.getElementById(
                "contact-form",
            ) as HTMLFormElement;
            const submitBtn = document.getElementById(
                "submit-btn",
            ) as HTMLButtonElement;
            const buttonText = submitBtn.querySelector(
                ".button-text",
            ) as HTMLElement;
            const loadingSpinner = submitBtn.querySelector(
                ".loading-spinner",
            ) as HTMLElement;
            const formResult = document.getElementById(
                "form-result",
            ) as HTMLElement;
            const messageTextarea = document.getElementById(
                "message",
            ) as HTMLTextAreaElement;
            const messageCount = document.getElementById(
                "message-count",
            ) as HTMLElement;

            // Contador de caracteres para el mensaje
            messageTextarea.addEventListener("input", () => {
                const count = messageTextarea.value.length;
                messageCount.textContent = count.toString();

                if (count > 1000) {
                    messageCount.style.color = "#ef4444";
                } else if (count > 900) {
                    messageCount.style.color = "#f59e0b";
                } else {
                    messageCount.style.color = "#6b7280";
                }
            });

            // Manejar envío del formulario
            form.addEventListener("submit", async (e) => {
                e.preventDefault();

                if (form.dataset.loading === "true") return;

                // Limpiar errores previos
                clearErrors();
                hideResult();

                // Obtener datos del formulario
                const formData = new FormData(form);
                const data = Object.fromEntries(formData.entries());

                // Validación del lado del cliente
                const validation = contactSchema.safeParse(data);

                if (!validation.success) {
                    showValidationErrors(validation.error.errors);
                    return;
                }

                // Mostrar loading
                setLoading(true);

                try {
                    const response = await fetch("/api/contact", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify(data),
                    });

                    const result = await response.json();

                    if (result.success) {
                        showResult("success", result.message);
                        form.reset();
                        messageCount.textContent = "0";
                    } else {
                        if (result.details) {
                            showValidationErrors(result.details);
                        } else {
                            showResult(
                                "error",
                                result.error || "Error al enviar el mensaje",
                            );
                        }
                    }
                } catch (error) {
                    console.error("Error:", error);
                    showResult(
                        "error",
                        "Error de conexión. Inténtalo más tarde.",
                    );
                } finally {
                    setLoading(false);
                }
            });

            function setLoading(loading: boolean) {
                form.dataset.loading = loading.toString();
                submitBtn.disabled = loading;

                if (loading) {
                    buttonText.style.display = "none";
                    loadingSpinner.style.display = "block";
                } else {
                    buttonText.style.display = "block";
                    loadingSpinner.style.display = "none";
                }
            }

            function clearErrors() {
                const errorElements = form.querySelectorAll(".error-message");
                const inputElements = form.querySelectorAll(
                    ".form-input, .form-textarea",
                );

                errorElements.forEach((el) => (el.textContent = ""));
                inputElements.forEach((el) => {
                    el.classList.remove("error");
                    el.classList.remove("border-red-500");
                    el.classList.remove("bg-red-50");
                });
            }

            function showValidationErrors(errors: any[]) {
                errors.forEach((error) => {
                    const field =
                        typeof error === "object" && "field" in error
                            ? error.field
                            : error.path?.[0];
                    const message =
                        typeof error === "object" && "message" in error
                            ? error.message
                            : error.message;

                    if (field) {
                        const input = form.querySelector(
                            `[name="${field}"]`,
                        ) as HTMLElement;
                        const errorElement = document.getElementById(
                            `${field}-error`,
                        );

                        if (input && errorElement) {
                            input.classList.add("error");
                            // Add Tailwind error visuals
                            input.classList.add("border-red-500");
                            input.classList.add("bg-red-50");
                            errorElement.textContent = message;
                        }
                    }
                });
            }

            function showResult(type: "success" | "error", message: string) {
                // Reset classes
                formResult.classList.remove(
                    "hidden",
                    "border-red-500",
                    "bg-red-50",
                    "text-red-700",
                    "border-green-500",
                    "bg-green-50",
                    "text-green-700",
                );
                formResult.querySelector(".result-message")!.textContent =
                    message;

                if (type === "success") {
                    formResult.classList.add(
                        "border-green-500",
                        "bg-green-50",
                        "text-green-700",
                    );
                } else {
                    formResult.classList.add(
                        "border-red-500",
                        "bg-red-50",
                        "text-red-700",
                    );
                }

                // Show
                formResult.classList.remove("hidden");

                // Scroll al resultado
                formResult.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                });

                // Auto-hide success messages
                if (type === "success") {
                    setTimeout(() => {
                        hideResult();
                    }, 5000);
                }
            }

            function hideResult() {
                formResult.classList.add("hidden");
            }
        });
    </script>
</form>
